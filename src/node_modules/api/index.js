const cars = require("./data/data.json");

async function sleep(seconds) {
  return new Promise(resolve => {
    setTimeout(resolve, seconds * 1000);
  });
}

const vehicles = Object.freeze(cars);

module.exports.getVehicles = async function getCarDetails(query) {
  await sleep(Math.random());
  let result = vehicles;

  if (query) {
    const params = new window.URLSearchParams(query);
    const search = params.get("search");
    const page = params.get("page");
    const searchConditon = vehicle =>
      `${vehicle.make}`
        .toLocaleLowerCase()
        .includes(`${search.toLocaleLowerCase()}`) ||
      `${vehicle.model}`
        .toLocaleLowerCase()
        .includes(`${search.toLocaleLowerCase()}`);

    if (search) {
      const vehiclesBySearch = vehicles.filter(vehicle =>
        searchConditon(vehicle)
      );
      result = vehiclesBySearch;
    }

    if (page) {
      const maxPagesNumber = Math.ceil(result.length / 5);
      if (Number(page) < maxPagesNumber) {
        const startIndex = (Number(page) - 1) * 5;
        const endIndex = (Number(page) - 1) * 5 + 5;
        const vehiclesByPage = result.slice(startIndex, endIndex);
        console.log({ startIndex, endIndex, result });
        result = vehiclesByPage;
      } else if (Number(page) >= maxPagesNumber) {
        const startIndex = (Number(maxPagesNumber) - 1) * 5;
        const endIndex = (Number(maxPagesNumber) - 1) * 5 + 5;
        const vehiclesByPage = result.slice(startIndex, endIndex);
        console.log({ startIndex, endIndex, result });
        result = vehiclesByPage;
      }
    }
  }

  return result;
};
